version: "1.0"

metadata:
  name: "Salon Complete Service Process"
  description: "End-to-end salon service from booking to completion and payment"
  industry: "salon"
  process_type: "order-to-cash"
  tags: ["booking", "beauty", "commission", "inventory"]

setup:
  organization:
    name: "Glamour Beauty & Wellness Salon"
    business_type: "salon"
  
  entities:
    # Beauty Services
    - entity_type: "service"
      entity_name: "Hair Cut & Style"
      entity_code: "HAIR-CUT-001"
      smart_code: "HERA.SALON.SVC.ENT.HAIR.v1"
      dynamic_fields:
        price: 85.00
        cost: 15.00
        duration_minutes: 60
        requires_specialist: true
        category: "hair"
        skill_level: "intermediate"
    
    - entity_type: "service"
      entity_name: "Gel Manicure"
      entity_code: "NAIL-GEL-001"
      smart_code: "HERA.SALON.SVC.ENT.NAILS.v1"
      dynamic_fields:
        price: 45.00
        cost: 8.00
        duration_minutes: 45
        requires_specialist: false
        category: "nails"
        skill_level: "basic"
    
    # Staff Members
    - entity_type: "employee"
      entity_name: "Isabella Rodriguez"
      entity_code: "STYLIST-001"
      smart_code: "HERA.SALON.EMP.ENT.STYLIST.v1"
      dynamic_fields:
        specialties: ["hair", "color"]
        commission_rate: 0.40
        hourly_rate: 25.00
        availability: "full_time"
        experience_years: 8
        client_rating: 4.8
    
    - entity_type: "employee"
      entity_name: "Maria Kim"
      entity_code: "NAIL-TECH-001"
      smart_code: "HERA.SALON.EMP.ENT.NAILTECH.v1"
      dynamic_fields:
        specialties: ["nails", "pedicure"]
        commission_rate: 0.35
        hourly_rate: 20.00
        availability: "part_time"
        certifications: ["gel", "acrylic", "nail_art"]
    
    # Products/Inventory
    - entity_type: "product"
      entity_name: "Premium Hair Shampoo"
      entity_code: "PROD-SHAMP-001"
      smart_code: "HERA.SALON.INV.ENT.PRODUCT.v1"
      dynamic_fields:
        cost: 12.00
        retail_price: 28.00
        stock_quantity: 50
        category: "hair_care"
        usage_per_service: 0.1  # 10% of bottle per service

steps:
  # Step 1: Customer Registration and Booking
  - id: "customer"
    name: "Register returning client"
    type: "create_entity"
    data:
      entity_type: "customer"
      entity_name: "Sarah Johnson"
      entity_code: "CLIENT-SJ-001"
      smart_code: "HERA.SALON.CUST.ENT.CLIENT.v1"
      dynamic_fields:
        phone: "+971-55-987-6543"
        email: "sarah.johnson@email.com"
        preferred_stylist: "Isabella Rodriguez"
        hair_type: "curly"
        color_allergies: ["ammonia"]
        last_visit: "2024-10-15"
        loyalty_points: 250
        vip_status: true
    validations:
      - type: "exists"
        field: "id"
      - type: "equals"
        field: "dynamic_fields.vip_status"
        expected: true

  # Step 2: Create appointment booking
  - id: "booking"
    name: "Create double service booking"
    type: "create_transaction"
    data:
      transaction_type: "appointment"
      transaction_code: "BOOK-20241201-001"
      smart_code: "HERA.SALON.BOOK.TXN.APPOINTMENT.v1"
      total_amount: 130.00  # Hair + nails
      from_entity_id: "{{customer.id}}"
      to_entity_id: "booking_system"
      line_items:
        - line_entity_id: "{{setup.hair_service.id}}"
          quantity: 1
          unit_price: 85.00
          line_amount: 85.00
          smart_code: "HERA.SALON.BOOK.LINE.SERVICE.v1"
          metadata:
            scheduled_date: "2024-12-01"
            scheduled_time: "14:00"
            assigned_staff: "{{setup.stylist.id}}"
            estimated_duration: 60
            special_requests: "layers and volume"
        - line_entity_id: "{{setup.manicure.id}}"
          quantity: 1
          unit_price: 45.00
          line_amount: 45.00
          smart_code: "HERA.SALON.BOOK.LINE.SERVICE.v1"
          metadata:
            scheduled_date: "2024-12-01"
            scheduled_time: "15:30"
            assigned_staff: "{{setup.nail_tech.id}}"
            estimated_duration: 45
            nail_color: "classic_red"
    validations:
      - type: "equals"
        field: "total_amount"
        expected: 130.00
      - type: "equals"
        field: "line_items.length"
        expected: 2

  # Step 3: Customer check-in
  - id: "checkin"
    name: "Process customer check-in"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.id}}"
      to_entity_id: "status_checked_in"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        checked_in_at: "{{now}}"
        receptionist: "front_desk_001"
        offered_refreshments: true
        wait_time_minutes: 5

  # Step 4: Start hair service
  - id: "hair_service_start"
    name: "Begin hair cutting service"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.line_items[0].id}}"
      to_entity_id: "status_in_progress"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        started_at: "{{now}}"
        stylist_id: "{{setup.stylist.id}}"
        consultation_notes: "Client wants layered cut with volume, maintain length"

  # Step 5: Record product usage
  - id: "product_usage"
    name: "Track product consumption during service"
    type: "create_transaction"
    data:
      transaction_type: "inventory_usage"
      transaction_code: "INV-USE-001"
      smart_code: "HERA.SALON.INV.TXN.USAGE.v1"
      total_amount: 1.20  # Cost of products used
      from_entity_id: "{{setup.shampoo.id}}"
      to_entity_id: "{{booking.id}}"
      line_items:
        - line_entity_id: "{{setup.shampoo.id}}"
          quantity: 0.1  # 10% of bottle
          unit_price: 12.00
          line_amount: 1.20
          smart_code: "HERA.SALON.INV.LINE.USAGE.v1"
          metadata:
            used_by: "{{setup.stylist.id}}"
            service_id: "{{setup.hair_service.id}}"

  # Step 6: Complete hair service
  - id: "hair_service_complete"
    name: "Complete hair cutting service"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.line_items[0].id}}"
      to_entity_id: "status_completed"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        completed_at: "{{now}}"
        duration_actual: 65  # 5 minutes over estimate
        client_satisfaction: 5
        before_after_photos: true
        styling_notes: "Beautiful layers achieved, client very happy"

  # Step 7: Start nail service
  - id: "nail_service_start"
    name: "Begin manicure service"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.line_items[1].id}}"
      to_entity_id: "status_in_progress"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        started_at: "{{now}}"
        technician_id: "{{setup.nail_tech.id}}"
        nail_condition: "healthy"
        color_choice: "classic_red"

  # Step 8: Complete nail service
  - id: "nail_service_complete"
    name: "Complete manicure service"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.line_items[1].id}}"
      to_entity_id: "status_completed"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        completed_at: "{{now}}"
        duration_actual: 40  # 5 minutes under estimate
        finish_quality: "excellent"
        drying_time: 15
        aftercare_provided: true

  # Step 9: Generate service invoice
  - id: "service_invoice"
    name: "Generate final service invoice"
    type: "create_transaction"
    data:
      transaction_type: "invoice"
      transaction_code: "INV-SJ-001"
      smart_code: "HERA.SALON.INV.TXN.BILL.v1"
      total_amount: 143.00  # Services + tax + discount
      from_entity_id: "{{customer.id}}"
      to_entity_id: "pos_system"
      line_items:
        - line_entity_id: "{{booking.id}}"
          quantity: 1
          unit_price: 130.00
          line_amount: 130.00
          smart_code: "HERA.SALON.INV.LINE.SERVICES.v1"
        - line_entity_id: "vat_tax"
          quantity: 1
          unit_price: 6.50
          line_amount: 6.50
          smart_code: "HERA.SALON.INV.LINE.TAX.v1"
        - line_entity_id: "vip_discount"
          quantity: 1
          unit_price: -6.50
          line_amount: -6.50
          smart_code: "HERA.SALON.INV.LINE.DISCOUNT.v1"
          metadata:
            discount_type: "vip_loyalty"
            discount_percentage: 5
    validations:
      - type: "equals"
        field: "total_amount"
        expected: 130.00  # Net after discount and tax cancel out

  # Step 10: Process payment
  - id: "payment"
    name: "Process customer payment with tip"
    type: "create_transaction"
    data:
      transaction_type: "payment"
      transaction_code: "PAY-SJ-001"
      smart_code: "HERA.SALON.PAY.TXN.CARD.v1"
      total_amount: 155.00  # Invoice + tip
      from_entity_id: "{{customer.id}}"
      to_entity_id: "payment_processor"
      line_items:
        - line_entity_id: "{{service_invoice.id}}"
          quantity: 1
          unit_price: 130.00
          line_amount: 130.00
          smart_code: "HERA.SALON.PAY.LINE.INVOICE.v1"
        - line_entity_id: "tip_stylist"
          quantity: 1
          unit_price: 17.00
          line_amount: 17.00
          smart_code: "HERA.SALON.PAY.LINE.TIP.v1"
          metadata:
            tip_percentage: 20.0
            recipient_id: "{{setup.stylist.id}}"
            service_type: "hair"
        - line_entity_id: "tip_nail_tech"
          quantity: 1
          unit_price: 8.00
          line_amount: 8.00
          smart_code: "HERA.SALON.PAY.LINE.TIP.v1"
          metadata:
            tip_percentage: 17.8
            recipient_id: "{{setup.nail_tech.id}}"
            service_type: "nails"
    validations:
      - type: "equals"
        field: "total_amount"
        expected: 155.00

  # Step 11: Calculate staff commissions
  - id: "commission_calculation"
    name: "Calculate staff commission payouts"
    type: "create_transaction"
    data:
      transaction_type: "commission"
      transaction_code: "COMM-001"
      smart_code: "HERA.SALON.HR.TXN.COMMISSION.v1"
      total_amount: 49.75  # Total commission to pay out
      from_entity_id: "payroll_system"
      to_entity_id: "commission_pool"
      line_items:
        - line_entity_id: "{{setup.stylist.id}}"
          quantity: 1
          unit_price: 34.00
          line_amount: 34.00  # 40% of 85 + 17 tip
          smart_code: "HERA.SALON.HR.LINE.COMMISSION.v1"
          metadata:
            base_commission: 34.00  # 40% of 85
            tip_amount: 17.00
            service_revenue: 85.00
            commission_rate: 0.40
        - line_entity_id: "{{setup.nail_tech.id}}"
          quantity: 1
          unit_price: 15.75
          line_amount: 15.75  # 35% of 45 + 8 tip
          smart_code: "HERA.SALON.HR.LINE.COMMISSION.v1"
          metadata:
            base_commission: 15.75  # 35% of 45
            tip_amount: 8.00
            service_revenue: 45.00
            commission_rate: 0.35

  # Step 12: Update loyalty points
  - id: "loyalty_update"
    name: "Award loyalty points to customer"
    type: "create_relationship"
    data:
      from_entity_id: "{{customer.id}}"
      to_entity_id: "loyalty_points"
      relationship_type: "earned_points"
      smart_code: "HERA.SALON.LOYALTY.POINTS.EARN.v1"
      metadata:
        points_earned: 13  # 1 point per 10 AED spent
        previous_balance: 250
        new_balance: 263
        earning_date: "{{now}}"
        source_transaction: "{{payment.id}}"

  # Step 13: Complete appointment
  - id: "appointment_complete"
    name: "Mark appointment as fully complete"
    type: "create_relationship"
    data:
      from_entity_id: "{{booking.id}}"
      to_entity_id: "status_completed"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        completed_at: "{{now}}"
        total_duration: 105  # minutes
        services_completed: 2
        client_satisfaction: 5
        rebook_scheduled: false
        review_requested: true

  # Step 14: Final validation
  - id: "final_validation"
    name: "Validate complete salon process"
    type: "validate"
    validations:
      - type: "equals"
        field: "{{payment.total_amount}}"
        expected: 155.00
      - type: "equals"
        field: "{{commission_calculation.total_amount}}"
        expected: 49.75
      - type: "business_rule"
        field: "profitability"
        oracle: "calculateProfitability"
        params: [130.00, 24.20, 49.75]  # revenue, product_costs, commission_costs
      - type: "greater_than"
        field: "{{customer.dynamic_fields.loyalty_points}}"
        expected: 250

teardown:
  clean_data: true
  preserve_logs: true