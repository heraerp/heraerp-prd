version: "1.0"

metadata:
  name: "Healthcare Complete Patient Visit Process"
  description: "End-to-end patient visit from registration to billing and payment"
  industry: "healthcare"
  process_type: "custom"
  tags: ["appointment", "ehr", "billing", "insurance"]

setup:
  organization:
    name: "Family Health Medical Center"
    business_type: "healthcare"
  
  entities:
    # Medical Services
    - entity_type: "service"
      entity_name: "General Consultation"
      entity_code: "CONSULT-GEN"
      smart_code: "HERA.HLTH.SVC.ENT.PROCEDURE.v1"
      dynamic_fields:
        price: 180.00
        cpt_code: "99213"
        duration_minutes: 30
        requires_authorization: false
    
    - entity_type: "service"
      entity_name: "Blood Pressure Check"
      entity_code: "VITALS-BP"
      smart_code: "HERA.HLTH.SVC.ENT.PROCEDURE.v1"
      dynamic_fields:
        price: 25.00
        cpt_code: "99000"
        duration_minutes: 5
        included_in_consultation: true
    
    # Healthcare Provider
    - entity_type: "employee"
      entity_name: "Dr. Sarah Johnson"
      entity_code: "PROV-001"
      smart_code: "HERA.HLTH.PROV.ENT.PHYSICIAN.v1"
      dynamic_fields:
        specialty: "Family Medicine"
        license_number: "MD-12345"
        npi_number: "1234567890"
    
    # Insurance Company
    - entity_type: "vendor"
      entity_name: "Emirates Health Insurance"
      entity_code: "INS-EHI"
      smart_code: "HERA.HLTH.INS.ENT.PAYER.v1"
      dynamic_fields:
        copay_amount: 50.00
        coverage_percentage: 80
        prior_auth_required: false

steps:
  # Step 1: Patient Registration
  - id: "patient"
    name: "Register new patient"
    type: "create_entity"
    data:
      entity_type: "patient"
      entity_name: "Ahmed Al-Mansouri"
      entity_code: "PAT-20241201-001"
      smart_code: "HERA.HLTH.PAT.ENT.PROFILE.v1"
      dynamic_fields:
        date_of_birth: "1978-03-15"
        phone: "+971-50-123-4567"
        email: "ahmed.almansouri@email.com"
        emergency_contact: "Fatima Al-Mansouri"
        emergency_phone: "+971-50-987-6543"
        medical_record_number: "MRN-2024-001"
        insurance_id: "EHI-987654321"
        insurance_group: "CORPORATE-PLAN-A"
    validations:
      - type: "exists"
        field: "id"
      - type: "contains"
        field: "dynamic_fields.medical_record_number"
        expected: "MRN"

  # Step 2: Link patient to insurance
  - id: "patient_insurance"
    name: "Link patient to insurance provider"
    type: "create_relationship"
    data:
      from_entity_id: "{{patient.id}}"
      to_entity_id: "{{setup.insurance.id}}"
      relationship_type: "insured_by"
      smart_code: "HERA.HLTH.INS.REL.COVERAGE.v1"
      metadata:
        policy_number: "EHI-987654321"
        group_number: "CORP-A"
        effective_date: "2024-01-01"
        expiry_date: "2024-12-31"
        copay_amount: 50.00
        deductible: 500.00
        deductible_met: 200.00

  # Step 3: Schedule appointment
  - id: "appointment"
    name: "Schedule patient appointment"
    type: "create_transaction"
    data:
      transaction_type: "appointment"
      transaction_code: "APPT-20241201-001"
      smart_code: "HERA.HLTH.APPT.TXN.SCHEDULE.v1"
      total_amount: 180.00
      from_entity_id: "{{patient.id}}"
      to_entity_id: "{{setup.provider.id}}"
      line_items:
        - line_entity_id: "{{setup.consultation.id}}"
          quantity: 1
          unit_price: 180.00
          line_amount: 180.00
          smart_code: "HERA.HLTH.APPT.LINE.SERVICE.v1"
          metadata:
            scheduled_date: "2024-12-01"
            scheduled_time: "10:30"
            duration_minutes: 30
            room_number: "102"
            chief_complaint: "Annual checkup and blood pressure monitoring"
    validations:
      - type: "exists"
        field: "id"
      - type: "equals"
        field: "total_amount"
        expected: 180.00

  # Step 4: Patient check-in
  - id: "checkin"
    name: "Process patient check-in"
    type: "create_relationship"
    data:
      from_entity_id: "{{appointment.id}}"
      to_entity_id: "status_checked_in"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        checked_in_at: "{{now}}"
        front_desk_staff: "receptionist_001"
        copay_collected: 50.00

  # Step 5: Vitals collection
  - id: "vitals"
    name: "Record patient vitals"
    type: "create_transaction"
    data:
      transaction_type: "clinical_data"
      transaction_code: "VITALS-001"
      smart_code: "HERA.HLTH.CLIN.TXN.VITALS.v1"
      total_amount: 0.00  # No charge for vitals
      from_entity_id: "{{patient.id}}"
      to_entity_id: "nurse_001"
      line_items:
        - line_entity_id: "{{setup.bp_check.id}}"
          quantity: 1
          unit_price: 0.00
          line_amount: 0.00
          smart_code: "HERA.HLTH.CLIN.LINE.VITAL.v1"
          metadata:
            systolic: 128
            diastolic: 82
            pulse: 72
            temperature: 98.6
            weight: 75.2
            height: 175

  # Step 6: Provider consultation
  - id: "consultation"
    name: "Conduct medical consultation"
    type: "create_transaction"
    data:
      transaction_type: "medical_service"
      transaction_code: "CONSULT-001"
      smart_code: "HERA.HLTH.CLIN.TXN.CONSULT.v1"
      total_amount: 180.00
      from_entity_id: "{{patient.id}}"
      to_entity_id: "{{setup.provider.id}}"
      line_items:
        - line_entity_id: "{{setup.consultation.id}}"
          quantity: 1
          unit_price: 180.00
          line_amount: 180.00
          smart_code: "HERA.HLTH.CLIN.LINE.SERVICE.v1"
          metadata:
            start_time: "10:30"
            end_time: "11:00"
            diagnosis_codes: ["Z00.00", "I10"]
            treatment_plan: "Continue current BP medication, follow-up in 6 months"
            prescriptions: ["Lisinopril 10mg daily"]
    validations:
      - type: "business_rule"
        field: "appointment_validation"
        oracle: "validateHealthcareAppointment"
        params:
          patientId: "{{patient.id}}"
          providerId: "{{setup.provider.id}}"
          startTime: "2024-12-01T10:30:00Z"
          duration: 30
          serviceType: "consultation"

  # Step 7: Generate medical bill
  - id: "medical_bill"
    name: "Generate patient medical bill"
    type: "create_transaction"
    data:
      transaction_type: "medical_bill"
      transaction_code: "BILL-001"
      smart_code: "HERA.HLTH.BILL.TXN.INVOICE.v1"
      total_amount: 180.00
      from_entity_id: "{{patient.id}}"
      to_entity_id: "billing_department"
      line_items:
        - line_entity_id: "{{consultation.id}}"
          quantity: 1
          unit_price: 180.00
          line_amount: 180.00
          smart_code: "HERA.HLTH.BILL.LINE.SERVICE.v1"
          metadata:
            service_date: "2024-12-01"
            provider_npi: "1234567890"
            diagnosis_codes: ["Z00.00", "I10"]
            procedure_codes: ["99213"]
    validations:
      - type: "equals"
        field: "total_amount"
        expected: 180.00

  # Step 8: Process insurance claim
  - id: "insurance_claim"
    name: "Submit insurance claim"
    type: "create_transaction"
    data:
      transaction_type: "insurance_claim"
      transaction_code: "CLAIM-001"
      smart_code: "HERA.HLTH.INS.TXN.CLAIM.v1"
      total_amount: 130.00  # 180 - 50 copay
      from_entity_id: "billing_department"
      to_entity_id: "{{setup.insurance.id}}"
      line_items:
        - line_entity_id: "{{medical_bill.id}}"
          quantity: 1
          unit_price: 130.00
          line_amount: 130.00
          smart_code: "HERA.HLTH.INS.LINE.CLAIM.v1"
          metadata:
            claim_type: "primary"
            patient_responsibility: 50.00  # Copay
            insurance_responsibility: 130.00

  # Step 9: Collect patient payment
  - id: "patient_payment"
    name: "Collect copay from patient"
    type: "create_transaction"
    data:
      transaction_type: "payment"
      transaction_code: "PAY-COPAY-001"
      smart_code: "HERA.HLTH.PAY.TXN.COPAY.v1"
      total_amount: 50.00
      from_entity_id: "{{patient.id}}"
      to_entity_id: "payment_processor"
      line_items:
        - line_entity_id: "{{medical_bill.id}}"
          quantity: 1
          unit_price: 50.00
          line_amount: 50.00
          smart_code: "HERA.HLTH.PAY.LINE.COPAY.v1"
          metadata:
            payment_method: "credit_card"
            card_last_four: "1234"
            authorization_code: "AUTH123456"

  # Step 10: Receive insurance payment
  - id: "insurance_payment"
    name: "Receive payment from insurance"
    type: "create_transaction"
    data:
      transaction_type: "payment"
      transaction_code: "PAY-INS-001"
      smart_code: "HERA.HLTH.PAY.TXN.INSURANCE.v1"
      total_amount: 104.00  # 80% of 130
      from_entity_id: "{{setup.insurance.id}}"
      to_entity_id: "accounts_receivable"
      line_items:
        - line_entity_id: "{{insurance_claim.id}}"
          quantity: 1
          unit_price: 104.00
          line_amount: 104.00
          smart_code: "HERA.HLTH.PAY.LINE.INSURANCE.v1"
          metadata:
            payment_date: "2024-12-15"
            check_number: "INS789456"
            adjustment_amount: 26.00  # 20% not covered
            adjustment_reason: "contractual_adjustment"

  # Step 11: Complete patient visit
  - id: "visit_complete"
    name: "Mark patient visit as complete"
    type: "create_relationship"
    data:
      from_entity_id: "{{appointment.id}}"
      to_entity_id: "status_completed"
      relationship_type: "has_status"
      smart_code: "HERA.WORKFLOW.STATUS.ASSIGN.v1"
      metadata:
        completed_at: "{{now}}"
        total_revenue: 154.00  # 50 copay + 104 insurance
        patient_satisfaction_score: 9
        follow_up_required: true
        follow_up_date: "2024-06-01"

  # Step 12: Final validation
  - id: "final_validation"
    name: "Validate complete healthcare process"
    type: "validate"
    validations:
      - type: "equals"
        field: "{{patient_payment.total_amount}}"
        expected: 50.00
      - type: "equals"
        field: "{{insurance_payment.total_amount}}"
        expected: 104.00
      - type: "business_rule"
        field: "total_collected"
        oracle: "validateAccountingEquation"
        params: [154.00, 0.00, 154.00]  # Total collected should equal revenue

teardown:
  clean_data: true
  preserve_logs: true