{
  "code": "HERA.SALON.APPT.TXN.BOOKING.V1",
  "kind": "transaction",
  "version": "v1",
  "metadata": {
    "title": "Salon Appointment Booking",
    "description": "Customer appointment with services and products",
    "author": "HERA Team",
    "tags": ["salon", "appointment", "booking", "transaction"]
  },
  "rules": {
    "fields": {
      "p_organization_id": {
        "type": "text",
        "format": "uuid",
        "required": true
      },
      "p_smart_code": {
        "type": "text",
        "required": true
      },
      "p_transaction_type": {
        "type": "text",
        "default": "appointment"
      },
      "p_transaction_date": {
        "type": "date",
        "required": true,
        "description": "Date of appointment"
      },
      "p_total_amount": {
        "type": "number",
        "required": true,
        "min": 0,
        "description": "Total appointment value"
      },
      "p_source_entity_id": {
        "type": "text",
        "format": "uuid",
        "required": true,
        "description": "Customer entity ID"
      },
      "p_target_entity_id": {
        "type": "text",
        "format": "uuid",
        "required": true,
        "description": "Location/branch entity ID"
      },
      "p_transaction_currency_code": {
        "type": "text",
        "format": "currency-3",
        "required": true,
        "default": "AED"
      },
      "appointment_time": {
        "type": "text",
        "required": true,
        "regex": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
        "description": "Appointment time (HH:MM)"
      },
      "status": {
        "type": "text",
        "required": true,
        "enum": [
          "booked",
          "confirmed",
          "arrived",
          "in_progress",
          "completed",
          "cancelled",
          "no_show"
        ],
        "default": "booked"
      },
      "total_duration_minutes": {
        "type": "number",
        "min": 15,
        "max": 480,
        "description": "Total appointment duration"
      },
      "notes": {
        "type": "text",
        "length": { "max": 1000 },
        "description": "Special instructions or notes"
      }
    },
    "line_fields": {
      "line_number": {
        "type": "number",
        "required": true,
        "min": 1
      },
      "line_type": {
        "type": "text",
        "required": true,
        "enum": ["SERVICE", "PRODUCT", "TAX", "DISCOUNT", "TIP"]
      },
      "entity_id": {
        "type": "text",
        "format": "uuid",
        "description": "Service or product entity ID"
      },
      "description": {
        "type": "text",
        "required": true,
        "length": { "max": 500 }
      },
      "quantity": {
        "type": "number",
        "required": true,
        "min": 0,
        "max": 999
      },
      "unit_amount": {
        "type": "number",
        "required": true,
        "min": 0
      },
      "line_amount": {
        "type": "number",
        "required": true
      },
      "smart_code": {
        "type": "text",
        "required": true,
        "description": "Line-level smart code"
      },
      "stylist_id": {
        "type": "text",
        "format": "uuid",
        "description": "Stylist/therapist entity ID"
      },
      "start_time": {
        "type": "text",
        "regex": "^([01]?[0-9]|2[0-3]):[0-5][0-9]$",
        "description": "Service start time"
      },
      "duration_minutes": {
        "type": "number",
        "min": 15,
        "max": 480,
        "description": "Service duration"
      }
    },
    "posting": {
      "currency": {
        "require_base": false,
        "allow_exchange_rate": false
      },
      "lines": [
        {
          "match": { "line_type": "SERVICE" },
          "derive": {
            "line_amount": "quantity * unit_amount",
            "polarity": "debit"
          },
          "validate": ["stylist_id != null", "duration_minutes > 0"]
        },
        {
          "match": { "line_type": "PRODUCT" },
          "derive": {
            "line_amount": "quantity * unit_amount",
            "polarity": "debit"
          }
        },
        {
          "match": { "line_type": "TAX" },
          "derive": {
            "polarity": "debit"
          },
          "validate": ["line_amount >= 0"]
        },
        {
          "match": { "line_type": "DISCOUNT" },
          "derive": {
            "line_amount": "-1 * abs(line_amount)",
            "polarity": "credit"
          }
        },
        {
          "match": { "line_type": "TIP" },
          "derive": {
            "polarity": "debit"
          },
          "validate": ["line_amount >= 0"]
        }
      ],
      "require_balanced": false
    },
    "transforms": [{ "op": "trim", "fields": ["notes"] }],
    "requires": [
      {
        "when": "status=='completed'",
        "then": "total_amount > 0"
      }
    ]
  },
  "procedures": [
    {
      "name": "Create Appointment",
      "fn": "hera_transaction_create_v1",
      "params": "payload"
    }
  ]
}
