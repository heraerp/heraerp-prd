{
  "guardrails": [
    {
      "id": "ORG-PARENT-DEPRECATED",
      "description": "Do not use parent_organization_id; model hierarchy via entities/relationships.",
      "applies_to": ["db.row", "api.payload"],
      "when": { "table": "core_organizations" },
      "validators": [
        { 
          "type": "column_must_be_null", 
          "column": "parent_organization_id",
          "message": "Use relationships in a Governance Org for group structure instead of parent_organization_id"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.ORG.PARENT.DEPRECATED.v1"
    },
    {
      "id": "POSTING-PERIOD-CLOSED",
      "description": "Prevent posting to closed fiscal periods",
      "applies_to": ["universal_transactions", "api.payload"],
      "validators": [
        { 
          "type": "callout", 
          "function": "hera.check_period_open",
          "message": "Cannot post to closed fiscal period"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.PERIOD.CLOSED.BLOCK.v1"
    },
    {
      "id": "SMART-CODE-FORMAT",
      "description": "Enforce lowercase 'v' in version suffix",
      "applies_to": ["db.row", "api.payload"],
      "when": { "column_present": "smart_code" },
      "validators": [
        {
          "type": "regex",
          "column": "smart_code",
          "pattern": "^HERA\\.[A-Z0-9]+\\.[A-Z0-9]+\\.[A-Z0-9]+\\.[A-Z0-9]+\\.v\\d+$",
          "message": "Smart code must use lowercase 'v' (e.g., HERA.FIN.GL.JE.v1, not V1)"
        }
      ],
      "severity": "error",
      "auto_fix": {
        "type": "regex_replace",
        "pattern": "\\.V(\\d+)$",
        "replacement": ".v$1"
      },
      "smart_code": "HERA.GUARDRAIL.SMART.CODE.FORMAT.v1"
    },
    {
      "id": "GL-BALANCED-LINES",
      "description": "GL transactions must have balanced debit/credit lines",
      "applies_to": ["universal_transactions"],
      "when": { 
        "smart_code_pattern": ".*\\.GL\\..*"
      },
      "validators": [
        {
          "type": "callout",
          "function": "hera.validate_gl_balance",
          "message": "GL entries must balance (total debits = total credits)"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.GL.BALANCE.REQUIRED.v1"
    },
    {
      "id": "ENTITY-TYPE-NORMALIZATION",
      "description": "Normalize gl_account to account entity type",
      "applies_to": ["core_entities", "api.payload"],
      "when": { "entity_type": "gl_account" },
      "validators": [
        {
          "type": "transform",
          "field": "entity_type",
          "from": "gl_account",
          "to": "account",
          "message": "Use entity_type='account' with metadata.ledger_type instead of 'gl_account'"
        }
      ],
      "severity": "warning",
      "auto_fix": {
        "type": "field_update",
        "field": "entity_type",
        "value": "account"
      },
      "smart_code": "HERA.GUARDRAIL.ENTITY.TYPE.NORMALIZE.v1"
    },
    {
      "id": "IDEMPOTENCY-EXTERNAL-REF",
      "description": "Use external_reference for idempotency keys",
      "applies_to": ["universal_transactions"],
      "when": { 
        "transaction_type": "idempotency_cache"
      },
      "validators": [
        {
          "type": "required_field",
          "field": "external_reference",
          "message": "Idempotency transactions must use external_reference field"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.IDEMPOTENCY.EXTERNAL.REF.v1"
    },
    {
      "id": "INTERCOMPANY-PAIRING",
      "description": "Intercompany transactions require pairing metadata",
      "applies_to": ["universal_transaction_lines"],
      "when": {
        "smart_code_pattern": ".*\\.INTERCO\\..*"
      },
      "validators": [
        {
          "type": "required_metadata",
          "fields": ["interco_pair_id", "counterparty_org_id"],
          "message": "Intercompany transactions must include pairing metadata"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.INTERCO.PAIRING.v1"
    },
    {
      "id": "PII-ENCRYPTION-REQUIRED",
      "description": "PII must be encrypted in dynamic data",
      "applies_to": ["core_dynamic_data"],
      "when": {
        "field_name_pattern": "^(ssn|tax_id|bank_account|credit_card|passport).*"
      },
      "validators": [
        {
          "type": "metadata_present",
          "field": "encryption",
          "subfields": ["key_id", "algorithm", "encrypted_at"],
          "message": "PII fields must be encrypted with KMS"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.PII.ENCRYPTION.v1"
    },
    {
      "id": "AUDIT-SMART-CODES",
      "description": "Audit transactions must use proper smart codes",
      "applies_to": ["universal_transactions"],
      "when": {
        "transaction_type": "audit"
      },
      "validators": [
        {
          "type": "smart_code_family",
          "allowed_families": [
            "HERA.SECURITY.AUDIT.*",
            "HERA.ADMIN.AUDIT.*",
            "HERA.COMPLIANCE.AUDIT.*"
          ],
          "message": "Audit transactions must use audit-specific smart codes"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.AUDIT.SMART.CODE.v1"
    },
    {
      "id": "ORGANIZATION-ID-REQUIRED",
      "description": "All operations must include organization_id",
      "applies_to": ["db.row", "api.payload"],
      "when": {
        "table_in": [
          "core_entities",
          "core_dynamic_data", 
          "core_relationships",
          "universal_transactions",
          "universal_transaction_lines"
        ]
      },
      "validators": [
        {
          "type": "required_field",
          "field": "organization_id",
          "message": "organization_id is required for multi-tenant isolation"
        }
      ],
      "severity": "error",
      "smart_code": "HERA.GUARDRAIL.ORG.ID.REQUIRED.v1"
    }
  ]
}