#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# UI Pattern Validation
echo "ðŸ” Checking UI patterns..."
npm run ui:validate

if [ $? -ne 0 ]; then
  echo "âŒ UI pattern validation failed. Please fix the issues before committing."
  echo "ðŸ’¡ Run 'npm run ui:validate' to see details"
  exit 1
fi

# Format check
echo "ðŸ“ Checking code formatting..."
npm run format:check

if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues found."
  echo "ðŸ’¡ Run 'npm run format' to fix automatically"
  exit 1
fi

echo "âœ… All checks passed!"

# Schema compat guard (fail if rewrites needed)
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\\.ya?ml$' || true)
if [ -n "$FILES" ]; then
  echo "ðŸ§­ Checking HERA bundle schema (compat guard)..."
  npm run schema:precommit
  if [ $? -ne 0 ]; then
    echo "âŒ Legacy bundle fields detected that require compat rewrite."
    echo "ðŸ’¡ Run 'npm run schema:compat:write -- .' to persist rewrites, then re-commit."
    exit 1
  fi
fi

# Rebuild DAG graph for changed bundles (optional)
if command -v dot >/dev/null 2>&1; then
  npm run schema:graph -- . >/dev/null 2>&1 || true
  if git ls-files --error-unmatch .hera/graph.dot >/dev/null 2>&1; then
    git add .hera/graph.dot .hera/graph.svg 2>/dev/null || true
  fi
fi
